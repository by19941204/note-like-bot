name: Visit note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/3 * * * *'

jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-07 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # 館長: 4个独立Job (不同IP + 不同设备)
  visit-1a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
              locale:'ja-JP',
              viewport:{width:1920,height:1080}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('館長: Windows Chrome');
          })();
          "

  visit-1b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
              locale:'ja-JP',
              viewport:{width:1440,height:900}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('館長: Mac Chrome');
          })();
          "

  visit-1c:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
              locale:'ja-JP',
              viewport:{width:390,height:844},
              isMobile:true
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,300));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('館長: iPhone Safari');
          })();
          "

  visit-1d:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Mobile Safari/537.36',
              locale:'ja-JP',
              viewport:{width:412,height:915},
              isMobile:true
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,300));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('館長: Android Chrome');
          })();
          "

  # カフェ: 3个独立Job
  visit-2a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0',
              locale:'ja-JP',
              viewport:{width:1366,height:768}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('カフェ: Windows Firefox');
          })();
          "

  visit-2b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Macintosh; Intel Mac OS X 14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15',
              locale:'ja-JP',
              viewport:{width:1680,height:1050}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('カフェ: Mac Safari');
          })();
          "

  visit-2c:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (iPad; CPU OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1',
              locale:'ja-JP',
              viewport:{width:1024,height:1366}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,400));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('カフェ: iPad Safari');
          })();
          "

  # 冬休み: 2个独立Job
  visit-3a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0',
              locale:'ja-JP',
              viewport:{width:1536,height:864}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n939384d205b5',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('冬休み: Windows Edge');
          })();
          "

  visit-3b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (Linux; Android 14; SM-S918B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Mobile Safari/537.36',
              locale:'ja-JP',
              viewport:{width:360,height:780},
              isMobile:true
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n939384d205b5',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,300));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('冬休み: Samsung Galaxy');
          })();
          "

  # 展示会: 1个独立Job (最少)
  visit-4a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const ctx=await b.newContext({
              userAgent:'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
              locale:'ja-JP',
              viewport:{width:1920,height:1080}
            });
            const p=await ctx.newPage();
            await p.goto('https://note.com/funeshiru/n/n81d639277d5e',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await p.evaluate(()=>window.scrollTo(0,500));
            await p.waitForTimeout(1000);
            await b.close();
            console.log('展示会: Linux Chrome');
          })();
          "
