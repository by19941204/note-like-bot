name: Visit note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/3 * * * *'

jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-05 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # 每个job是独立的服务器 = 不同IP
  # 館長: 最多 (4个独立job)
  visit-1a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('館長: 1 visit');
          })();
          "

  visit-1b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('館長: 1 visit');
          })();
          "

  visit-1c:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('館長: 1 visit');
          })();
          "

  visit-1d:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('館長: 1 visit');
          })();
          "

  # カフェ: 3个独立job
  visit-2a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('カフェ: 1 visit');
          })();
          "

  visit-2b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('カフェ: 1 visit');
          })();
          "

  visit-2c:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('カフェ: 1 visit');
          })();
          "

  # 冬休み: 2个独立job
  visit-3a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n939384d205b5',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('冬休み: 1 visit');
          })();
          "

  visit-3b:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n939384d205b5',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('冬休み: 1 visit');
          })();
          "

  # 展示会: 1个独立job (最少)
  visit-4a:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          node -e "
          const {chromium}=require('playwright');
          (async()=>{
            const b=await chromium.launch();
            const p=await b.newPage();
            await p.goto('https://note.com/funeshiru/n/n81d639277d5e',{waitUntil:'networkidle'});
            await p.waitForTimeout(3000);
            await b.close();
            console.log('展示会: 1 visit');
          })();
          "
