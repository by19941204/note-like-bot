name: Visit note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-07 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # 館長: 5个设备 (最多)
  visit-kancho:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [1,2,3,4,5]
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          DEVICES='[
            {"ua":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/122.0.0.0","w":1920,"h":1080},
            {"ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 Chrome/122.0.0.0","w":1440,"h":900},
            {"ua":"Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15","w":390,"h":844},
            {"ua":"Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 Chrome/122.0.0.0","w":412,"h":915},
            {"ua":"Mozilla/5.0 (iPad; CPU OS 17_3 like Mac OS X) AppleWebKit/605.1.15","w":1024,"h":1366}
          ]'
          IDX=$(( ${{ matrix.device }} - 1 ))
          node -e "
          const {chromium}=require('playwright');
          const d=$DEVICES[$IDX];
          (async()=>{
            const b=await chromium.launch();
            const p=await (await b.newContext({userAgent:d.ua,locale:'ja-JP',viewport:{width:d.w,height:d.h}})).newPage();
            await p.goto('https://note.com/funeshiru/n/nc9282c02f880',{waitUntil:'networkidle',timeout:30000});
            await p.waitForTimeout(2000+Math.random()*2000);
            await b.close();
            console.log('館長: Device ${{ matrix.device }}');
          })().catch(e=>console.log('Error:',e.message));
          "

  # カフェ: 4个设备
  visit-cafe:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [1,2,3,4]
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          DEVICES='[
            {"ua":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Firefox/123.0","w":1366,"h":768},
            {"ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 14_3) AppleWebKit/605.1.15 Safari/605.1.15","w":1680,"h":1050},
            {"ua":"Mozilla/5.0 (Linux; Android 14; SM-S918B) AppleWebKit/537.36 Chrome/122.0.0.0","w":360,"h":780},
            {"ua":"Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15","w":375,"h":812}
          ]'
          IDX=$(( ${{ matrix.device }} - 1 ))
          node -e "
          const {chromium}=require('playwright');
          const d=$DEVICES[$IDX];
          (async()=>{
            const b=await chromium.launch();
            const p=await (await b.newContext({userAgent:d.ua,locale:'ja-JP',viewport:{width:d.w,height:d.h}})).newPage();
            await p.goto('https://note.com/funeshiru/n/n708d5812b976',{waitUntil:'networkidle',timeout:30000});
            await p.waitForTimeout(2000+Math.random()*2000);
            await b.close();
            console.log('カフェ: Device ${{ matrix.device }}');
          })().catch(e=>console.log('Error:',e.message));
          "

  # 冬休み: 4个设备
  visit-fuyu:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [1,2,3,4]
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          DEVICES='[
            {"ua":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Edg/122.0.0.0","w":1536,"h":864},
            {"ua":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 Chrome/122.0.0.0","w":1920,"h":1080},
            {"ua":"Mozilla/5.0 (Linux; Android 13; SM-A546B) AppleWebKit/537.36 Chrome/121.0.0.0","w":384,"h":854},
            {"ua":"Mozilla/5.0 (iPad; CPU OS 16_6 like Mac OS X) AppleWebKit/605.1.15","w":820,"h":1180}
          ]'
          IDX=$(( ${{ matrix.device }} - 1 ))
          node -e "
          const {chromium}=require('playwright');
          const d=$DEVICES[$IDX];
          (async()=>{
            const b=await chromium.launch();
            const p=await (await b.newContext({userAgent:d.ua,locale:'ja-JP',viewport:{width:d.w,height:d.h}})).newPage();
            await p.goto('https://note.com/funeshiru/n/n939384d205b5',{waitUntil:'networkidle',timeout:30000});
            await p.waitForTimeout(2000+Math.random()*2000);
            await b.close();
            console.log('冬休み: Device ${{ matrix.device }}');
          })().catch(e=>console.log('Error:',e.message));
          "

  # 展示会: 3个设备 (最少)
  visit-tenji:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [1,2,3]
    steps:
      - run: |
          npm init -y && npm install playwright && npx playwright install chromium
          DEVICES='[
            {"ua":"Mozilla/5.0 (Windows NT 11.0; Win64; x64) AppleWebKit/537.36 Chrome/121.0.0.0","w":2560,"h":1440},
            {"ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 13_6) AppleWebKit/537.36 Chrome/121.0.0.0","w":1280,"h":800},
            {"ua":"Mozilla/5.0 (Linux; Android 14; Pixel 7) AppleWebKit/537.36 Chrome/122.0.0.0","w":393,"h":851}
          ]'
          IDX=$(( ${{ matrix.device }} - 1 ))
          node -e "
          const {chromium}=require('playwright');
          const d=$DEVICES[$IDX];
          (async()=>{
            const b=await chromium.launch();
            const p=await (await b.newContext({userAgent:d.ua,locale:'ja-JP',viewport:{width:d.w,height:d.h}})).newPage();
            await p.goto('https://note.com/funeshiru/n/n81d639277d5e',{waitUntil:'networkidle',timeout:30000});
            await p.waitForTimeout(2000+Math.random()*2000);
            await b.close();
            console.log('展示会: Device ${{ matrix.device }}');
          })().catch(e=>console.log('Error:',e.message));
          "
