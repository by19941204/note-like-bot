name: Visit note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-05 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  visit-all:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium
          
      - name: Visit pages
        run: |
          cat > visit.js << 'SCRIPT'
          const { chromium } = require('playwright');

          const articles = [
            { key: 'nc9282c02f880', name: '館長', times: 8 },
            { key: 'n708d5812b976', name: 'カフェ', times: 5 },
            { key: 'n939384d205b5', name: '冬休み', times: 4 },
            { key: 'n81d639277d5e', name: '展示会', times: 3 },
          ];

          async function main() {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/122.0.0.0',
              locale: 'ja-JP'
            });
            
            let total = 0;
            for (const article of articles) {
              for (let i = 0; i < article.times; i++) {
                try {
                  const page = await context.newPage();
                  await page.goto(`https://note.com/funeshiru/n/${article.key}`, { waitUntil: 'domcontentloaded', timeout: 15000 });
                  await page.waitForTimeout(2000);
                  await page.close();
                  total++;
                } catch (e) {
                  console.log(`Error: ${e.message.substring(0, 30)}`);
                }
              }
              console.log(`${article.name}: ${article.times} visits`);
            }
            
            await browser.close();
            console.log(`Total: ${total} visits`);
          }

          main().catch(console.error);
          SCRIPT
          
          node visit.js
