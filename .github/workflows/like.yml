name: Like note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  # 今天24:00后停止
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-05 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏰ 已到期"
          fi

  # 冬休み: 目标120-150 (当前104, 需要+16~46)
  like-article1:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n939384d205b5
        run: |
          # 70%概率执行
          if [ $((RANDOM % 10)) -lt 7 ]; then
            NOTE_KEY="n939384d205b5"
            curl -s -c /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" -H "User-Agent: Mozilla/5.0" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" -H "Origin: https://note.com" -d '{}'
            echo "Done: 冬休み"
          else
            echo "Skipped"
          fi

  # カフェ: 目标160-190 (当前104, 需要+56~86)
  like-article2:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n708d5812b976
        run: |
          # 90%概率执行 (需要更多)
          if [ $((RANDOM % 10)) -lt 9 ]; then
            NOTE_KEY="n708d5812b976"
            curl -s -c /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" -H "User-Agent: Mozilla/5.0" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" -H "Origin: https://note.com" -d '{}'
            echo "Done: カフェ"
          else
            echo "Skipped"
          fi

  # 展示会: 目标130-160 (当前104, 需要+26~56)
  like-article3:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n81d639277d5e
        run: |
          # 50%概率执行
          if [ $((RANDOM % 10)) -lt 5 ]; then
            NOTE_KEY="n81d639277d5e"
            curl -s -c /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" -H "User-Agent: Mozilla/5.0" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" -H "Origin: https://note.com" -d '{}'
            echo "Done: 展示会"
          else
            echo "Skipped"
          fi

  # 館長: 目标190-200 (当前186, 只需要+4~14)
  like-article4:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like nc9282c02f880
        run: |
          # 20%概率执行 (已经很多)
          if [ $((RANDOM % 10)) -lt 2 ]; then
            NOTE_KEY="nc9282c02f880"
            curl -s -c /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" -H "User-Agent: Mozilla/5.0" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" -H "Origin: https://note.com" -d '{}'
            echo "Done: 館長"
          else
            echo "Skipped"
          fi
