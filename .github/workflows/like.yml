name: Like note.com

on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  # 今天24:00后停止
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          NOW=$(TZ=Asia/Tokyo date +%s)
          END=$(TZ=Asia/Tokyo date -d "2026-02-05 00:00:00" +%s)
          if [ $NOW -lt $END ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⏰ 已到期"
          fi

  # 冬休み: 37%概率
  like-article1:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n939384d205b5
        run: |
          if [ $((RANDOM % 100)) -lt 37 ]; then
            NOTE_KEY="n939384d205b5"
            UA="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
            curl -s -c /tmp/c.txt -b /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" -H "Accept-Language: ja-JP,ja;q=0.9" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" \
              -H "Origin: https://note.com" \
              -H "Referer: https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" \
              -H "Accept: application/json" \
              -H "X-Requested-With: XMLHttpRequest" \
              -d '{}'
            echo "Done: 冬休み"
          else
            echo "Skipped"
          fi

  # カフェ: 63%概率
  like-article2:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n708d5812b976
        run: |
          if [ $((RANDOM % 100)) -lt 63 ]; then
            NOTE_KEY="n708d5812b976"
            UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
            curl -s -c /tmp/c.txt -b /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" -H "Accept-Language: ja-JP,ja;q=0.9" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" \
              -H "Origin: https://note.com" \
              -H "Referer: https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" \
              -H "Accept: application/json" \
              -H "X-Requested-With: XMLHttpRequest" \
              -d '{}'
            echo "Done: カフェ"
          else
            echo "Skipped"
          fi

  # 展示会: 17%概率 (最少)
  like-article3:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like n81d639277d5e
        run: |
          if [ $((RANDOM % 100)) -lt 17 ]; then
            NOTE_KEY="n81d639277d5e"
            UA="Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
            curl -s -c /tmp/c.txt -b /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" -H "Accept-Language: ja-JP,ja;q=0.9" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" \
              -H "Origin: https://note.com" \
              -H "Referer: https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" \
              -H "Accept: application/json" \
              -H "X-Requested-With: XMLHttpRequest" \
              -d '{}'
            echo "Done: 展示会"
          else
            echo "Skipped"
          fi

  # 館長: 97%概率 (最多)
  like-article4:
    needs: check-date
    if: needs.check-date.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Like nc9282c02f880
        run: |
          if [ $((RANDOM % 100)) -lt 97 ]; then
            NOTE_KEY="nc9282c02f880"
            UA="Mozilla/5.0 (Linux; Android 14; Pixel 8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Mobile Safari/537.36"
            curl -s -c /tmp/c.txt -b /tmp/c.txt "https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" -H "Accept-Language: ja-JP,ja;q=0.9" > /dev/null
            curl -s -X POST "https://note.com/api/v3/notes/${NOTE_KEY}/likes" -b /tmp/c.txt \
              -H "Content-Type: application/json" \
              -H "Origin: https://note.com" \
              -H "Referer: https://note.com/funeshiru/n/${NOTE_KEY}" \
              -H "User-Agent: $UA" \
              -H "Accept: application/json" \
              -H "X-Requested-With: XMLHttpRequest" \
              -d '{}'
            echo "Done: 館長"
          else
            echo "Skipped"
          fi
